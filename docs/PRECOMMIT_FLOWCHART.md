# Pre-commit 检查流程

## 检查流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Git Commit 触发                                 │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │  .githooks/pre-commit │
                    │  (钩子包装脚本)        │
                    └──────────┬───────────┘
                               │
                               ▼
        ┌──────────────────────────────────────────┐
        │  scripts/pre-commit.sh (完整检查)         │
        │  ├─ SKIP_PRECOMMIT=1? → 跳过全部        │
        │  └─ 否则继续 ↓                          │
        └──────────────┬───────────────────────────┘
                       │
    ┌──────────────────┼──────────────────┐
    │                  │                  │
    ▼                  ▼                  ▼
┌────────────┐   ┌──────────────┐  ┌──────────────┐
│ 1. 格式    │   │ 2. Linting   │  │ 3. Deny      │
│ 检查       │   │ (2x clippy)  │  │ 检查         │
│            │   │              │  │              │
│ rustfmt    │   │ all-features │  │ advisories   │
│ --check    │   │ + default    │  │ licenses     │
│            │   │              │  │ bans         │
│ (1-2 min)  │   │ (8-15 min)   │  │ sources      │
│            │   │              │  │              │
│ ✓ 格式正确 │   │ ✓ 无警告     │  │ (2-5 min)    │
└──────┬─────┘   └──────┬───────┘  │ ✓ 安全无漏洞 │
       │                │          └──────┬──────┘
       └────────────────┼──────────────────┘
                        │
    ┌───────────────────┼────────────────┐
    │                   │                │
    ▼                   ▼                ▼
┌─────────────┐   ┌──────────────┐  ┌──────────────┐
│ 4. 构建验证  │   │ 5. 测试      │  │ 6. 文档      │
│             │   │              │  │ 生成         │
│ cargo build │   │ cargo test   │  │              │
│ (2x)        │   │ (3 suites)   │  │ cargo doc    │
│             │   │              │  │              │
│ default     │   │ unit         │  │ 456+ 测试    │
│ + all-feat  │   │ integration  │  │              │
│             │   │ doc-tests    │  │ (5-10 min)   │
│(10-20 min)  │   │              │  │              │
│ ✓ 编译通过  │   │(20-40 min)   │  │ ✓ 无文档警告 │
└──────┬──────┘   │ ✓ 456通过    │  └──────┬──────┘
       │          └──────┬───────┘         │
       └──────────────────┼─────────────────┘
                          │
    ┌─────────────────────┼────────────────┐
    │                     │                │
    ▼                     ▼                ▼
┌──────────────┐    ┌──────────────┐  ┌──────────────┐
│ 7. 代码覆盖   │    │ 8. 安全审计   │  │ 9. 结果总结  │
│              │    │              │  │              │
│ llvm-cov     │    │ cargo-audit  │  │ 统计通过/失败│
│              │    │              │  │              │
│ codecov.json │    │ RustSec DB   │  │ 彩色输出     │
│              │    │              │  │              │
│(15-30 min)   │    │(1-2 min)     │  │ 推荐后续步骤 │
│ ✓ 覆盖率生成 │    │ ✓ 无漏洞     │  └──────┬──────┘
└──────┬───────┘    └──────┬───────┘         │
       │                   │                 │
       └───────────────────┼─────────────────┘
                           │
              ┌────────────┴────────────┐
              │                        │
              ▼                        ▼
    ┌─────────────────────┐  ┌─────────────────────┐
    │ ✅ 全部通过         │  │ ❌ 某些检查失败      │
    │ exit 0              │  │ exit 1              │
    │ 允许提交            │  │ 阻止提交            │
    │ 显示完成消息        │  │ 显示失败列表        │
    └─────────────────────┘  └─────────────────────┘
```

## 时间线

```
开始
  │
  ├─> 1-2 min    : 格式检查
  │
  ├─> 8-15 min   : Clippy 全feature
  ├─> 3-5 min    : Clippy 默认feature
  │
  ├─> 2-5 min    : cargo-deny 检查
  │
  ├─> 5-10 min   : 默认feature编译
  ├─> 10-15 min  : 全feature编译
  │
  ├─> 20-40 min  : 测试运行 (456 tests)
  ├─> 5-10 min   : 文档测试
  ├─> 5-10 min   : 文档生成
  │
  ├─> 15-30 min  : 代码覆盖率
  │
  ├─> 1-2 min    : 安全审计
  │
  └─> 完成! 总耗时: 90-160 分钟
```

## 快速检查流程

```
┌─────────────────────────────────────────────────────┐
│           scripts/pre-commit-quick.sh               │
│          (用于开发期间的快速反馈)                   │
└──────────────────────┬────────────────────────────┘
                       │
    ┌──────────────────┼──────────────────┐
    │                  │                  │
    ▼                  ▼                  ▼
┌────────────┐   ┌──────────────┐  ┌──────────────┐
│ 1. 格式    │   │ 2. Linting   │  │ 3. Deny      │
│ 检查       │   │ (仅lib/bins) │  │ 检查         │
│            │   │              │  │              │
│ (1-2 min)  │   │ (2-3 min)    │  │ (2-5 min)    │
└────────┬───┘   └────────┬─────┘  └────────┬─────┘
         │                │                 │
         └────────────────┼─────────────────┘
                          │
    ┌─────────────────────┼────────────────┐
    │                     │                │
    ▼                     ▼                ▼
┌──────────────┐    ┌──────────────┐  ┌──────────────┐
│ 4. 快速语法   │    │ 5. 安全审计   │  │ 6. 结果总结  │
│              │    │              │  │              │
│ cargo check  │    │ cargo-audit  │  │ 快速反馈     │
│              │    │ (仅critical) │  │              │
│ (仅lib/bins) │    │              │  │              │
│              │    │              │  │              │
│(1-2 min)     │    │(1-2 min)     │  │ ✓ 或 ✗       │
└────────┬─────┘    └────────┬─────┘  └──────┬──────┘
         │                   │               │
         └───────────────────┼───────────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                    ▼                 ▼
          ┌─────────────────────┐   ┌──────────────┐
          │ ✅ 快速通过         │   │ ❌ 有问题    │
          │ (2-5 分钟)          │   │ 详见上方错误 │
          │                     │   └──────────────┘
          │ 继续开发            │
          └─────────────────────┘
```

## 执行决策树

```
                         git commit
                             │
                             ▼
                  SKIP_PRECOMMIT=1?
                       ├─ 是
                       │  └─> 跳过所有检查 ✓
                       │
                       └─ 否
                          │
                          ▼
              运行 .githooks/pre-commit
                          │
                          ▼
              运行 scripts/pre-commit.sh
                          │
         ┌────────────────┼────────────────┐
         │                │                │
   格式检查        Clippy 检查         Deny 检查
         │                │                │
    失败? 停止         失败? 停止       失败? 停止
    成功 继续         成功 继续       成功 继续
         │                │                │
         └────────────────┼────────────────┘
                          │
         ┌────────────────┼────────────────┐
         │                │                │
      构建检查          测试检查        文档检查
         │                │                │
    失败? 停止        失败? 停止      失败? 停止
    成功 继续        成功 继续       成功 继续
         │                │                │
         └────────────────┼────────────────┘
                          │
         ┌────────────────┼────────────────┐
         │                │                │
      覆盖率          安全审计         结果汇总
         │                │                │
    生成完成      SKIP_AUDIT=1?      所有通过?
    成功 继续         ├─ 是             ├─ 是
                      │  └─> 继续         │  └─> exit 0
                      │     (警告)        │     ✅ 允许提交
                      │                  │
                      └─ 否             └─ 否
                         │               exit 1
                      有漏洞?           ❌ 阻止提交
                         ├─ 是           显示失败清单
                         │  └─> exit 1
                         │
                         └─ 否
                            exit 0
```

## 环境变量控制

```
┌──────────────────────────────────────────────────┐
│              环境变量选项                        │
└────────────────────────────────────────────────┬─┘
                                                 │
                    ┌────────────────────────────┼────────────────────────────┐
                    │                            │                            │
                    ▼                            ▼                            ▼
        ┌────────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
        │  SKIP_PRECOMMIT=1      │  │  SKIP_AUDIT=1        │  │  正常模式 (默认)     │
        │                        │  │                      │  │                      │
        │  跳过所有检查          │  │  跳过安全审计        │  │  全部检查都运行      │
        │  (不推荐)              │  │  (不推荐)            │  │  (推荐)              │
        │                        │  │                      │  │                      │
        │  使用场景:             │  │  使用场景:           │  │  使用场景:           │
        │  - 紧急修复            │  │  - 临时跳过审计      │  │  - 正常开发          │
        │  - 强制推送测试        │  │  - 已知的无害漏洞    │  │  - 推送前验证        │
        │                        │  │                      │  │                      │
        │ SKIP_PRECOMMIT=1 \    │  │ SKIP_AUDIT=1 \       │  │ bash \               │
        │ git commit -m "..."   │  │ bash pre-commit.sh   │  │ scripts/pre-commit.sh │
        │                        │  │                      │  │                      │
        └────────────────────────┘  └──────────────────────┘  └──────────────────────┘
```

## 检查覆盖范围

```
┌─────────────────────────────────────────────────────┐
│           BrowerAI 检查覆盖范围                     │
└─────────────────────────────────────────────────────┘

代码质量 (Code Quality)
  ├─ 格式规范 (Format)          ← rustfmt
  ├─ 代码缺陷 (Bugs)            ← clippy
  ├─ 性能问题 (Performance)     ← clippy
  └─ 错误处理 (Error Handling)  ← clippy

安全性 (Security)
  ├─ 已知漏洞 (CVEs)             ← cargo-audit
  ├─ 密码学问题 (Crypto)         ← cargo-audit
  ├─ 许可证冲突 (Licenses)       ← cargo-deny
  ├─ 依赖来源 (Source Trust)     ← cargo-deny
  └─ 版本冲突 (Version Conflicts)← cargo-deny

可靠性 (Reliability)
  ├─ 编译成功 (Build)            ← cargo build
  ├─ 全功能编译 (All Features)   ← cargo build --all-features
  ├─ 测试通过 (Tests)            ← cargo test (456+ tests)
  ├─ 文档质量 (Documentation)    ← cargo doc
  └─ 文档示例 (Doc Examples)     ← cargo test --doc

可观测性 (Observability)
  └─ 代码覆盖率 (Coverage)       ← cargo llvm-cov → codecov.json
```

---

**说明**: 这个流程图展示了pre-commit检查系统的完整工作流程，包括决策树、时间成本和覆盖范围。
